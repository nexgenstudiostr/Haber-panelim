const RSSParser = require('rss-parser');
const fs = require('fs');
const parser = new RSSParser();

async function updateNews() {
    try {
        // Mevcut haberleri ve kaynakları oku
        const data = JSON.parse(fs.readFileSync('./src/data/news.json', 'utf8'));
        
        // Sadece link içeren objeleri (kaynakları) filtrele
        const sources = data.filter(item => item.link && item.link.includes('http'));
        let allNews = [];

        for (let source of sources) {
            try {
                console.log(`${source.source} çekiliyor...`);
                const feed = await parser.parseURL(source.link);
                
                const items = feed.items.map(item => ({
                    title: item.title,
                    link: item.link,
                    pubDate: item.pubDate || new Date().toISOString(),
                    source: source.source // Kaynak adını koru
                }));
                
                allNews = [...allNews, ...items];
            } catch (err) {
                console.log(`${source.source} çekilemedi:`, err.message);
            }
        }

        // Eğer yeni haber çekildiyse dosyayı güncelle
        if (allNews.length > 0) {
            // Haberleri tarihe göre sırala
            allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            // Hem kaynakları hem de haberleri bir arada tut (veya sadece haberleri)
            fs.writeFileSync('./src/data/news.json', JSON.stringify(allNews, null, 2));
            console.log('Haberler başarıyla güncellendi!');
        }
    } catch (error) {
        console.error('Hata:', error);
    }
}

updateNews();
